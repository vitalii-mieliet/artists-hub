# .github/workflows/dev-merge-notify.yml

name: Notify Discord and Slack on Merge to dev

on:
  pull_request:
    types: [closed]

jobs:
  notify-if-merged:
    if:
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    steps:
      - name: Prepare message
        id: pr_message
        run: |
          title=$(echo "${{ github.event.pull_request.title }}" | sed ':a;N;$!ba;s/\n/ /g')
          echo "title=$title" >> $GITHUB_OUTPUT

      - name: Send Discord message
        run: |
          message="üîÄ **Merge —É –≥—ñ–ª–∫—É \`dev\` —á–µ—Ä–µ–∑ GitHub!**\\nüîß –ó–ª–∏—Ç–æ –≥—ñ–ª–∫—É \`${{ github.event.pull_request.head.ref }}\`\\nüìù PR: *${{ steps.pr_message.outputs.title }}*\\n\\nüìå **–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º —Ä–æ–±–æ—Ç–∏ –∑–±–µ—Ä–µ–∂—ñ—Ç—å —ñ –æ–Ω–æ–≤—ñ—Ç—å —Å–≤–æ—ó –≥—ñ–ª–∫–∏:**\\n\`\`\`bash\\ngit add .\\ngit commit -m \\\"–í–∞—à –∫–æ–º—ñ—Ç\\\"\\ngit checkout dev\\ngit pull origin dev\\ngit checkout –≤–∞—à–∞-–≥—ñ–ª–∫–∞\ngit merge dev\n\`\`\`\n\nüîó [–î–∏–≤–∏—Ç–∏—Å—è Pull Request](${{ github.event.pull_request.html_url }})"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$message\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Send Slack message
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":twisted_rightwards_arrows: *Merge —É `dev`!* :rocket:\n–ó–ª–∏—Ç–æ `${{ github.event.pull_request.head.ref }}` ‚Üí `dev`\n*PR:* _${{ steps.pr_message.outputs.title }}_\n\n:pushpin: *–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º —Ä–æ–±–æ—Ç–∏ –∑–±–µ—Ä–µ–∂—ñ—Ç—å —ñ –æ–Ω–æ–≤—ñ—Ç—å —Å–≤–æ—ó –≥—ñ–ª–∫–∏:*\n```bash\ngit add .\ngit commit -m \"–í–∞—à –∫–æ–º—ñ—Ç\"\ngit checkout dev\ngit pull origin dev\ngit checkout –≤–∞—à–∞-–≥—ñ–ª–∫–∞\ngit merge dev\n\`\`\`\n\n<${{ github.event.pull_request.html_url }}|–ü–µ—Ä–µ–π—Ç–∏ –¥–æ Pull Request>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
