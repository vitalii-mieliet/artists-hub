# .github/workflows/dev-merge-notify.yml

name: Notify Discord and Slack on Merge to dev

on:
  pull_request:
    types: [closed]

jobs:
  notify-if-merged:
    if:
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    steps:
      - name: Prepare message
        id: pr_message
        run: |
          title=$(echo "${{ github.event.pull_request.title }}" | sed ':a;N;$!ba;s/\n/ /g')
          echo "title=$title" >> $GITHUB_OUTPUT

      - name: Send Discord message
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"ğŸ”€ **Merge Ñƒ Ğ³Ñ–Ğ»ĞºÑƒ \`dev\` Ñ‡ĞµÑ€ĞµĞ· GitHub!**\\nğŸ”§ Ğ—Ğ»Ğ¸Ñ‚Ğ¾ Ğ³Ñ–Ğ»ĞºÑƒ \`${{ github.event.pull_request.head.ref }}\`\\nğŸ“ PR: *${{ steps.pr_message.outputs.title }}*\\nğŸ”— [Ğ”Ğ¸Ğ²Ğ¸Ñ‚Ğ¸ÑÑ Pull Request](${{ github.event.pull_request.html_url }})\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Send Slack message
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":twisted_rightwards_arrows: *Merge Ñƒ `dev`!* :rocket:\nĞ—Ğ»Ğ¸Ñ‚Ğ¾ `${{ github.event.pull_request.head.ref }}` â†’ `dev`\n*PR:* _${{ steps.pr_message.outputs.title }}_\n<${{ github.event.pull_request.html_url }}|ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ´Ğ¾ Pull Request>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
