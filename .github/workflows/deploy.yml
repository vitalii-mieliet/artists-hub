name: Notify Discord on Push to Dev

on:
  push:
    branches:
      - dev

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for dependency changes
        id: deps_check
        run: |
          git fetch origin
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E 'package(-lock)?\.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare notification message
        id: notify_msg
        run: |
          COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed ':a;N;$!ba;s/\n/ /g')

          if [ "${{ steps.deps_check.outputs.changed }}" = "true" ]; then
            TEXT="ðŸ”„ Ð’Ð½ÐµÑÐµÐ½Ñ– Ð·Ð¼Ñ–Ð½Ð¸ Ð² Ð³Ñ–Ð»ÐºÑƒ \`dev\`: ðŸ“¦ **ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–!**\\n\\nÐ‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÐµÐ½Ð½ÑÐ¼ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð·Ð±ÐµÑ€ÐµÐ¶Ñ–Ñ‚ÑŒ Ñ– Ð¾Ð½Ð¾Ð²Ñ–Ñ‚ÑŒ ÑÐ²Ð¾Ñ— Ð³Ñ–Ð»ÐºÐ¸:\\n\`\`\`bash\\ngit add .\\ngit commit -m \\\"Ð’Ð°Ñˆ ÐºÐ¾Ð¼Ñ–Ñ‚\\\"\\ngit checkout dev\\ngit pull origin dev\\ngit checkout Ð²Ð°ÑˆÐ°-Ð³Ñ–Ð»ÐºÐ°\\n\\nnpm install\\n\`\`\`\\nðŸ“ ÐšÐ¾Ð¼Ñ–Ñ‚: $COMMIT_MESSAGE"
          else
            TEXT="ðŸ”„ Ð’Ð½ÐµÑÐµÐ½Ñ– Ð·Ð¼Ñ–Ð½Ð¸ Ð² Ð³Ñ–Ð»ÐºÑƒ \`dev\`.\\n\\nÐ‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÐµÐ½Ð½ÑÐ¼ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð·Ð±ÐµÑ€ÐµÐ¶Ñ–Ñ‚ÑŒ Ñ– Ð¾Ð½Ð¾Ð²Ñ–Ñ‚ÑŒ ÑÐ²Ð¾Ñ— Ð³Ñ–Ð»ÐºÐ¸:\\n\`\`\`bash\\ngit add .\\ngit commit -m \\\"Ð’Ð°Ñˆ ÐºÐ¾Ð¼Ñ–Ñ‚\\\"\\ngit checkout dev\\ngit pull origin dev\\ngit checkout Ð²Ð°ÑˆÐ°-Ð³Ñ–Ð»ÐºÐ°\\n\`\`\`\\nðŸ“ ÐšÐ¾Ð¼Ñ–Ñ‚: $COMMIT_MESSAGE"
          fi

          echo "msg=$TEXT" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ steps.notify_msg.outputs.msg }}
